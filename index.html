<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Catalog</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product {
            text-align: center;
            margin-bottom: 24px;
        }
        .product .product-title {
            padding-top: 15px;
            font-size: 12px;
            height: 3.25rem;
        }
        .product .product-price {
            font-size: 12px;
        }
        .product .btn {
            font-size: .75rem;
            padding: 2px;
        }
        .product img {
            max-width: 100%;
            height: 125px;
        }
        .input-group.mb-3 {
            margin-bottom: 8px;
        }
        .quantity-input {
            width: 60px;
            text-align: center;
            font-size: .75rem;
            padding: 0px;
        }
        .input-group-btn-vertical {
            position: relative;
            white-space: nowrap;
            width: 1%;
            vertical-align: middle;
            display: table-cell;
        }
        .input-group-btn-vertical > .btn {
            display: block;
            float: none;
            width: 100%;
            max-width: 100%;
            padding: 8px;
            margin-left: -1px;
            position: relative;
            border-radius: 0;
        }
        .input-group-btn-vertical > .btn:first-child {
            border-top-right-radius: 4px;
        }
        .input-group-btn-vertical > .btn:last-child {
            margin-top: -2px;
            border-bottom-right-radius: 4px;
        }
        .input-group-btn-vertical i {
            position: absolute;
            top: 0;
            left: 4px;
        }
        .input-group-btn-vertical .btn {
            padding: 6px 10px;
            font-size: 12px;
        }
        .row {
          display: -webkit-box;
          display: -webkit-flex;
          display: -ms-flexbox;
          display:         flex;
          flex-wrap: wrap;
        }
        .row > [class*='col-'] {
          display: flex;
          flex-direction: column;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row" id="product-list">
            <!-- <div class="col-6">
                <div class="product">
                    <img src="https://cdn.yellowmessenger.com/i5C5cU2jZQfF1663062340643.jpeg" alt="Product 1">
                    <h6 class="product-title">Sampoerna Limited Edition 16</h6>
                    <p class="product-price">Rp 28.100</p>
                    <div class="input-group mb-3">
                        <button class="btn btn-default" type="button" onclick="decrementQuantity(1)"><i class="fa fa-minus"></i></button>
                        <input type="text" class="form-control quantity-input" id="quantity1" value="0">
                        <button class="btn btn-default" type="button" onclick="incrementQuantity(1)"><i class="fa fa-plus"></i></button>
                    </div>
                    <button class="btn btn-success" onclick="addToCart()">+Keranjang ðŸ›’</button>
                </div>
            </div> -->

            
            <!-- <div class="d-grid gap-2">
                <button class="btn btn-success">Tambahkan ke Keranjang ðŸ›’</button>
            </div> -->
            <!-- Repeat the above two columns to create a 4x4 grid -->
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script>
        function incrementQuantity(productId) {
            var input = document.getElementById('quantity' + productId);
            var value = parseInt(input.value, 10);
            value = isNaN(value) ? 1 : value;
            value++;
            input.value = value;
        }
        
        function decrementQuantity(productId) {
            var input = document.getElementById('quantity' + productId);
            var value = parseInt(input.value, 10);
            value = isNaN(value) ? 1 : value;
            value--;
            if (value < 1) {
                value = 1;
            }
            input.value = value;
        }

        function addToCart() {
            let qty = document.getElementById("quantity1").value;
            
			window.parent.postMessage(JSON.stringify({
				event_code: 'ym-client-event',
				data: JSON.stringify({
					event: {
						code: "add-to-cart-webview",
						data: {
							qty: qty,
                            product_id: 100
						}
					}
				})
			}), '*');
        }

        // Function to decompress the parameters (simple implementation)
        function decompressParams(compressedString) {
            const binaryString = atob(compressedString);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const decoder = new TextDecoder();
            const decompressedString = decoder.decode(bytes);
            const pairs = decompressedString.split('&');
            const params = {};
            pairs.forEach(pair => {
                const [key, value] = pair.split('=');
                params[decodeURIComponent(key)] = decodeURIComponent(value.replaceAll("+", " "));
            });
            return params;
        }

        function convertParams(params) {
            const result = {};
            
            for (const key in params) {
                if (params.hasOwnProperty(key)) {
                    // Extract the prefix (e.g., param_0 or param_1)
                    const match = key.match(/^(.+?)\[.*\]$/);
                    if (match) {
                        const prefix = match[1];
                        
                        // Initialize the object for this prefix if it doesn't exist
                        if (!result[prefix]) {
                            result[prefix] = {};
                        }
                        
                        // Extract the property name (e.g., stick, offering)
                        const property = key.replace(`${prefix}[`, '').replace(']', '');
                        
                        // Assign the value to the proper object and property
                        result[prefix][property] = params[key];
                    }
                }
            }
            
            return result;
        }



        function convertToObjectArray(params) {
            const result = [];
            const groupedParams = {};

            // Group parameters by their prefix
            for (const key in params) {
                if (params.hasOwnProperty(key)) {
                    const match = key.match(/^(.+?)\[(.+?)\]$/);
                    if (match) {
                        const prefix = match[1];
                        const property = match[2];
                        
                        // Initialize the object for this prefix if it doesn't exist
                        if (!groupedParams[prefix]) {
                            groupedParams[prefix] = {};
                        }
                        
                        // Assign the property to the corresponding object
                        groupedParams[prefix][property] = params[key];
                    }
                }
            }

            // Convert grouped parameters to an array of objects
            for (const prefix in groupedParams) {
                if (groupedParams.hasOwnProperty(prefix)) {
                    result.push(groupedParams[prefix]);
                }
            }

            return result;
        }

        function formatRupiah(amountString) {
            const amount = amountString;

            // Format the number with thousands separators
            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0, // No decimal places
            });
            
            return formatter.format(amount);
        }

        function generateProductHTML(product, index) {
            let imageProduct = product.image ? product.image.split(',')[0] : 'https://cdn.yellowmessenger.com/wkoiPLe9DBu81650431575535.jpg';
            let productPrice = formatRupiah(product.unit_price)

            return `
                <div class="col-6 mb-4">
                    <div class="product">
                        <img src="${imageProduct}" alt="${product.name}" class="img-fluid">
                        <h6 class="product-title">${product.name}</h6>
                        <p class="product-price">${productPrice}</p>
                        <div class="input-group mb-3">
                            <button class="btn btn-default" type="button" onclick="decrementQuantity(${index})"><i class="fa fa-minus"></i></button>
                            <input type="text" class="form-control quantity-input" id="quantity${index}" value="0">
                            <button class="btn btn-default" type="button" onclick="incrementQuantity(${index})"><i class="fa fa-plus"></i></button>
                        </div>
                        <button class="btn btn-success" onclick="addToCart(${index})">+Keranjang ðŸ›’</button>
                    </div>
                </div>
            `;
        }

        const queryString = window.location.search;

        // Create a URLSearchParams object from the query string
        const urlParams = new URLSearchParams(queryString);
        const data = urlParams.get('data');

        // Decompress the parameters
        const decompressedParams = decompressParams(data);
        console.log('decompressParams:', decompressedParams);

        // Convert the URL parameters to an array of objects
        const produtsArr = convertToObjectArray(decompressedParams);
        console.log('Structured Array of produtsArr:', produtsArr);

        function renderProducts(products) {
            const productList = document.getElementById('product-list');
            productList.innerHTML = products.map((product, index) => generateProductHTML(product, index)).join('');
        }
        renderProducts(produtsArr);
    </script>
</body>
</html>
